#cloud-config
package_update: true
package_upgrade: true

write_files:
  - path: /usr/local/bin/kubeadm-single-node.sh
    permissions: "0755"
    content: |
      #!/usr/bin/env bash
      set -euo pipefail

      exec > >(tee /var/log/kubeadm-single-node.log) 2>&1

      # Basic deps
      apt-get update
      apt-get install -y ca-certificates curl gnupg lsb-release apt-transport-https jq

      # Disable swap (required by kubelet)
      swapoff -a || true
      sed -i.bak '/\sswap\s/s/^/#/' /etc/fstab || true

      # Kernel modules and sysctl for Kubernetes networking
      cat <<EOF >/etc/modules-load.d/k8s.conf
      overlay
      br_netfilter
      EOF
      modprobe overlay
      modprobe br_netfilter

      cat <<EOF >/etc/sysctl.d/k8s.conf
      net.bridge.bridge-nf-call-iptables  = 1
      net.bridge.bridge-nf-call-ip6tables = 1
      net.ipv4.ip_forward                 = 1
      EOF
      sysctl --system

      # Install containerd
      apt-get install -y containerd
      mkdir -p /etc/containerd
      containerd config default >/etc/containerd/config.toml

      # Use systemd cgroup driver (recommended for kubeadm)
      sed -i 's/SystemdCgroup = false/SystemdCgroup = true/' /etc/containerd/config.toml
      systemctl restart containerd
      systemctl enable containerd

      # Add Kubernetes apt repo (pkgs.k8s.io)
      mkdir -p /etc/apt/keyrings
      curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.29/deb/Release.key \
        | gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
      echo "deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.29/deb/ /" \
        >/etc/apt/sources.list.d/kubernetes.list

      apt-get update
      apt-get install -y kubelet kubeadm kubectl
      apt-mark hold kubelet kubeadm kubectl
      systemctl enable kubelet

      # Initialize cluster (single node)
      # Pod CIDR must match your chosen CNI. Calico default is 192.168.0.0/16
      kubeadm init --pod-network-cidr=192.168.0.0/16

      # Configure kubectl for ubuntu user
      USERNAME="ubuntu"
      USER_HOME="/home/${USERNAME}"
      mkdir -p "${USER_HOME}/.kube"
      cp -i /etc/kubernetes/admin.conf "${USER_HOME}/.kube/config"
      chown -R "${USERNAME}:${USERNAME}" "${USER_HOME}/.kube"

      # Also configure for root (handy for SSH as root)
      mkdir -p /root/.kube
      cp -i /etc/kubernetes/admin.conf /root/.kube/config

      # Allow scheduling on control-plane (single-node lab)
      kubectl taint nodes --all node-role.kubernetes.io/control-plane- || true

      # Install Calico CNI
      kubectl apply -f https://raw.githubusercontent.com/projectcalico/calico/v3.27.0/manifests/calico.yaml

      # Optional: wait a bit and show status
      sleep 10
      kubectl get nodes -o wide || true
      kubectl get pods -A || true

runcmd:
  - [ bash, -lc, "/usr/local/bin/kubeadm-single-node.sh" ]
